# SQL

## Оптимистические/Пессимистические блокировки

Оптимистические и пессимистические блокировки — это два подхода к управлению
конкурентным доступом к данным в многопользовательских системах, таких как базы
данных. Эти подходы помогают избежать конфликтов при одновременном изменении
данных несколькими пользователями.

### 1. Оптимистическая блокировка

**Описание**: Оптимистическая блокировка предполагает, что конфликты между
транзакциями происходят редко. Вместо того чтобы блокировать данные на время их
изменения, система позволяет пользователям изменять данные без блокировок, а
затем проверяет наличие конфликтов перед завершением транзакции.

**Как это работает**:

- При загрузке данных в приложение не устанавливаются блокировки.
- Пользователь вносит изменения и пытается сохранить их.
- Перед сохранением система проверяет, были ли данные изменены другими
  транзакциями с момента их загрузки.
- Если данные были изменены, транзакция отклоняется, и пользователь получает
  уведомление о конфликте. В противном случае изменения сохраняются.

**Преимущества**:

- Высокая производительность при низком уровне конфликтов.
- Меньше времени ожидания для пользователей, так как нет блокировок.

**Недостатки**:

- Возможность возникновения конфликтов и необходимость повторной попытки
  выполнения транзакции.
- Сложность обработки ошибок и управления состоянием приложения.

**Пример в Hibernate**:
В Hibernate оптимистическая блокировка может быть реализована с помощью версии (
version) поля:

```java

@Entity
public class Author {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @Version
    private int version; // Поле версии для оптимистической блокировки
}
```

### 2. Пессимистическая блокировка

**Описание**: Пессимистическая блокировка предполагает, что конфликты между
транзакциями происходят часто. Поэтому система блокирует данные на время их
изменения, чтобы предотвратить доступ других транзакций к этим данным.

**Как это работает**:

- При загрузке данных в приложение устанавливаются блокировки на уровне базы
  данных.
- Другие транзакции не могут получить доступ к заблокированным данным до тех
  пор, пока текущая транзакция не завершится (не будет зафиксирована или
  отменена).

**Преимущества**:

- Гарантия целостности данных при высоком уровне конфликтов.
- Упрощение логики обработки ошибок, так как конфликты предотвращаются заранее.

**Недостатки**:

- Потенциально низкая производительность из-за ожидания освобождения блокировок.
- Возможность возникновения взаимных блокировок (deadlocks).

**Пример в Hibernate**:
В Hibernate пессимистическая блокировка может быть реализована с помощью
аннотации `@Lock`:

```java
class Demo {
    void demo() {
        Session session = sessionFactory.openSession();
        Transaction tx = session.beginTransaction();
        Author author = session.get(Author.class, 1, LockMode.PESSIMISTIC_WRITE);
        // Здесь author будет заблокирован для других транзакций

        // Изменения...
        author.setName("New Name");
        tx.commit();
        session.close();


    }
}

```

### Заключение

Выбор между оптимистической и пессимистической блокировкой зависит от конкретных
требований вашего приложения и ожидаемого уровня конкуренции за ресурсы.
Оптимистическая блокировка лучше подходит для сценариев с низким уровнем
конфликтов, тогда как пессимистическая — для сценариев с высокой конкуренцией за
данные. Правильное понимание этих подходов поможет вам эффективно управлять
доступом к данным и обеспечивать целостность вашей системы.


> ## Индексы в SQL


